(()=>{"use strict";var e=function(e,t,s,n){return new(s||(s=Promise))((function(o,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function r(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}l((n=n.apply(e,t||[])).next())}))};class t{constructor(e,t){this.apiBaseUrl=e,this.apiKey=t}sendMessage(t){return e(this,void 0,void 0,(function*(){try{const e=yield fetch(`${this.apiBaseUrl}/conversation`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey},body:JSON.stringify(t)});if(!e.ok){const t=yield e.text().catch((()=>"No error details available"));throw new Error(`API error: ${e.status} - ${t}`)}return yield e.json()}catch(e){throw console.error("Error sending message:",e),e}}))}fetchConversation(t){return e(this,void 0,void 0,(function*(){try{const e=yield fetch(`${this.apiBaseUrl}/conversation/${t}`,{method:"GET",headers:{"Content-Type":"application/json","x-api-key":this.apiKey}});if(!e.ok){const t=yield e.text().catch((()=>"No error details available"));throw new Error(`API error: ${e.status} - ${t}`)}const s=yield e.json();return s.messageMap&&Object.keys(s.messageMap).forEach((e=>{s.messageMap[e].thinkingLog&&console.log(`Message ${e} has thinking log data`)})),s.citationMappings||(s.citationMappings={}),s}catch(e){throw console.error(`Error fetching conversation ${t}:`,e),e}}))}fetchMessage(t,s){return e(this,void 0,void 0,(function*(){try{const e=yield fetch(`${this.apiBaseUrl}/conversation/${t}/${s}`,{method:"GET",headers:{"Content-Type":"application/json","x-api-key":this.apiKey}});if(404===e.status)return console.log("Message not ready yet (404 response) - will retry"),{success:!1,error:"message_not_ready",status:404};if(!e.ok){const t=yield e.text().catch((()=>"No error details available"));return{success:!1,error:`API error: ${e.status} - ${t}`,status:e.status}}const n=yield e.json();return console.log("Message response data:",n),n.message&&(n.message.thinkingLog?console.log("Found thinking log in message response"):n.thinkingLog&&(n.message.thinkingLog=n.thinkingLog,console.log("Found thinking log at top level of response"))),{success:!0,message:n.message||n}}catch(e){return e instanceof Error?(console.error("Error fetching message:",e),{success:!1,error:e.message}):{success:!1,error:"Unknown error"}}}))}submitLead(t,s){return e(this,void 0,void 0,(function*(){try{const e="https://xs4dsewvc7.execute-api.us-east-1.amazonaws.com/prod/leads",n=t.userId||this.getUserId(),o=Object.assign(Object.assign({},t),{userId:n});console.log("Submitting lead with data:",{leadData:o,conversationId:s});const i=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leadData:o,conversationId:s})});if(!i.ok)return console.error("Failed to submit lead data:",yield i.text().catch((()=>"No error details available"))),!1;const a=yield i.json();return console.log("Lead submitted successfully:",a),!0}catch(e){return console.error("Error submitting lead data:",e),!1}}))}updateLeadConversation(t,s){return e(this,void 0,void 0,(function*(){try{const e="https://xs4dsewvc7.execute-api.us-east-1.amazonaws.com/prod/leads/update-conversation";console.log("Updating lead conversation:",{userId:t,conversationId:s});const n=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,conversationId:s})});if(!n.ok)return console.error("Failed to update lead conversation:",yield n.text().catch((()=>"No error details available"))),!1;const o=yield n.json();return console.log("Lead conversation updated successfully:",o),!0}catch(e){return console.error("Error updating lead conversation:",e),!1}}))}getUserId(){let e=localStorage.getItem("chatbot_user_id");return e||(e="user_"+Date.now()+"_"+Math.random().toString(36).substring(2,9),localStorage.setItem("chatbot_user_id",e)),e}checkUserExists(t){return e(this,void 0,void 0,(function*(){try{const e=localStorage.getItem(`user_${t}`);return e?JSON.parse(e):null}catch(e){return console.error("Error checking user existence:",e),null}}))}updateUserData(t){return e(this,void 0,void 0,(function*(){try{const e=`user_${t.userId}`,s=JSON.stringify(t);return localStorage.setItem(e,s),console.log("Saved user data to localStorage:",{key:e,data:s}),!0}catch(e){return console.error("Error updating user data:",e),!1}}))}}var s=function(e,t,s,n){return new(s||(s=Promise))((function(o,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function r(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}l((n=n.apply(e,t||[])).next())}))};class n{constructor(){this.storageKey="chatbot_uploaded_files",console.log("DevFileUploadService initialized for development")}uploadFile(e,t,n,o,i){return s(this,void 0,void 0,(function*(){try{null==i||i({fileId:"",fileName:e.name,progress:10,status:"uploading"});const s=`dev_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;null==i||i({fileId:s,fileName:e.name,progress:30,status:"uploading"});const a=yield this.readFileAsBase64(e);null==i||i({fileId:s,fileName:e.name,progress:60,status:"uploading"});const r={fileId:s,userId:t,userEmail:o,conversationId:n,fileName:e.name,originalName:e.name,fileSize:e.size,fileType:e.type,fileData:a,uploadTimestamp:(new Date).toISOString(),status:"uploaded"};return this.storeFileMetadata(r),null==i||i({fileId:s,fileName:e.name,progress:100,status:"uploaded"}),console.log("File uploaded successfully (dev mode):",e.name),r}catch(t){throw console.error("File upload failed (dev mode):",t),null==i||i({fileId:"",fileName:e.name,progress:0,status:"failed",error:t instanceof Error?t.message:"Upload failed"}),t}}))}readFileAsBase64(e){return new Promise(((t,s)=>{const n=new FileReader;n.onload=()=>{const e=n.result.split(",")[1];t(e)},n.onerror=()=>s(new Error("Failed to read file")),n.readAsDataURL(e)}))}storeFileMetadata(e){try{const t=this.getStoredFiles();t.push(e),t.length>50&&t.splice(0,t.length-50),localStorage.setItem(this.storageKey,JSON.stringify(t)),console.log("File metadata stored in localStorage")}catch(e){throw console.error("Failed to store file metadata:",e),e}}getStoredFiles(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to get stored files:",e),[]}}getUserFiles(e,t){return s(this,void 0,void 0,(function*(){const s=this.getStoredFiles();return t?s.filter((e=>e.conversationId===t)):s.filter((t=>t.userId===e))}))}deleteFile(e,t){return s(this,void 0,void 0,(function*(){const s=this.getStoredFiles(),n=s.filter((s=>!(s.fileId===e&&s.userId===t)));if(n.length===s.length)throw new Error("File not found or access denied");localStorage.setItem(this.storageKey,JSON.stringify(n)),console.log("File deleted from localStorage:",e)}))}getFileAsBlob(e){const t=this.getStoredFiles().find((t=>t.fileId===e));if(!t)return null;const s=atob(t.fileData),n=new Array(s.length);for(let e=0;e<s.length;e++)n[e]=s.charCodeAt(e);const o=new Uint8Array(n);return new Blob([o],{type:t.fileType})}getFileDownloadUrl(e){const t=this.getFileAsBlob(e);return t?URL.createObjectURL(t):null}revokeDownloadUrl(e){URL.revokeObjectURL(e)}}function o(e){try{localStorage.setItem("chatbotConversations",JSON.stringify(e))}catch(e){console.error("Error saving conversations to localStorage:",e)}}function i(e,t=18,s=18){const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width",t.toString()),n.setAttribute("height",s.toString()),n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("fill","none"),n.setAttribute("stroke","currentColor"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round");const o=document.createElementNS("http://www.w3.org/2000/svg","path");return o.setAttribute("d",e),n.appendChild(o),n}const a="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",r="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48";function l(e){return new Promise((t=>setTimeout(t,e)))}function c(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}class d{constructor(e,t,s){this.onSubmit=t,this.onSkip=s,this.element=this.createForm(),this.attachEventListeners(),setTimeout((()=>{const t=document.getElementById(e);t?t.appendChild(this.element):console.error(`Container with ID ${e} not found`)}),0)}createForm(){const e=document.createElement("div");e.className="lead-form-container",e.id="lead-form-container",e.style.maxHeight="70vh",e.style.overflowY="auto";const t=document.createElement("div");t.className="lead-form-header";const s=document.createElement("h3");s.textContent="Before we start chatting...",s.className="lead-form-title",t.appendChild(s);const n=document.createElement("p");n.textContent="Please share a bit about yourself so we can personalize your experience.",n.className="lead-form-subtitle",t.appendChild(n),e.appendChild(t);const o=document.createElement("form");o.id="lead-form",o.className="lead-form";const i=this.createFormGroup("name","Name","text","Your name");o.appendChild(i);const a=this.createFormGroup("email","Email","email","Your email address");o.appendChild(a);const r=this.createFormGroup("phone","Phone","tel","Your phone number");o.appendChild(r);const l=this.createFormGroup("country","Country","text","Your country");o.appendChild(l);const c=this.createFormGroup("state","State/Province","text","Your state or province");o.appendChild(c);const d=this.createFormGroup("city","City","text","Your city");o.appendChild(d);const h=this.createFormGroup("program","Interested Program","text","Program you are interested in");o.appendChild(h);const u=document.createElement("div");u.className="lead-form-buttons";const p=document.createElement("button");p.type="submit",p.id="lead-submit-btn",p.className="lead-submit-btn",p.textContent="Submit",p.style.backgroundColor="#d32f2f",p.style.color="white",u.appendChild(p);const m=document.createElement("button");return m.type="button",m.id="lead-skip-btn",m.className="lead-skip-btn",m.textContent="Skip for now",u.appendChild(m),o.appendChild(u),e.appendChild(o),this.applyStyles(e),e}createFormGroup(e,t,s,n){const o=document.createElement("div");o.className="form-group";const i=document.createElement("label");i.htmlFor=e,i.textContent=t,o.appendChild(i);const a=document.createElement("input");return a.type=s,a.id=e,a.name=e,a.placeholder=n,"email"===e&&(a.required=!0),o.appendChild(a),o}applyStyles(e){e.style.backgroundColor="white",e.style.borderRadius="8px",e.style.padding="20px",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.1)",e.style.width="100%",e.style.height="100%",e.style.maxWidth="",e.style.margin="",e.style.padding="0",e.style.boxShadow="";const t=e.querySelector(".lead-form");t&&(t.style.width="100%",t.style.height="100%",t.style.margin="0",t.style.padding="0");const s=e.querySelector(".lead-form-header");if(s){s.style.textAlign="center",s.style.marginBottom="10px";const e=s.querySelector(".lead-form-title");e&&(e.style.fontSize="18px",e.style.marginBottom="8px",e.style.color="#2d3748");const t=s.querySelector(".lead-form-subtitle");t&&(t.style.fontSize="14px",t.style.color="#718096",t.style.margin="0")}if(t){t.style.display="flex",t.style.flexDirection="column",t.style.gap="15px",t.querySelectorAll(".form-group").forEach((e=>{const t=e;t.style.display="flex",t.style.flexDirection="column",t.style.gap="5px";const s=t.querySelector("label");s&&(s.style.fontSize="14px",s.style.fontWeight="500",s.style.color="#4a5568");const n=t.querySelector("input");n&&(n.style.padding="10px",n.style.borderRadius="6px",n.style.border="1px solid #e2e8f0",n.style.fontSize="14px",n.style.outline="none",n.style.transition="border-color 0.3s ease")}));const e=t.querySelector(".lead-form-buttons");if(e){e.style.display="flex",e.style.justifyContent="space-between",e.style.marginTop="10px";const t=e.querySelector(".lead-submit-btn");t&&(t.style.backgroundColor="#d32f2f",t.style.color="white",t.style.border="none",t.style.padding="10px 20px",t.style.borderRadius="6px",t.style.cursor="pointer",t.style.fontSize="14px",t.style.fontWeight="500",t.style.transition="background-color 0.3s ease");const s=e.querySelector(".lead-skip-btn");s&&(s.style.backgroundColor="transparent",s.style.color="#718096",s.style.border="none",s.style.padding="10px",s.style.borderRadius="6px",s.style.cursor="pointer",s.style.fontSize="14px",s.style.transition="color 0.3s ease",s.style.textDecoration="underline")}}}attachEventListeners(){const e=this.element.querySelector("#lead-form"),t=this.element.querySelector("#lead-skip-btn");e&&e.addEventListener("submit",(t=>{t.preventDefault();const s=new FormData(e),n={name:s.get("name")||"",email:s.get("email")||"",phone:s.get("phone")||"",country:s.get("country")||"",state:s.get("state")||"",city:s.get("city")||"",program:s.get("program")||"",timestamp:Date.now(),userId:s.get("userId")||""};this.onSubmit(n)})),t&&t.addEventListener("click",(()=>{this.onSkip()}))}toggle(e){this.element.style.display=e?"flex":"none"}remove(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}var h=function(e,t,s,n){return new(s||(s=Promise))((function(o,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function r(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}l((n=n.apply(e,t||[])).next())}))};class u{constructor(e){this.leadForm=null,this.attachmentButton=null,this.fileInput=null,this.uploadProgressContainer=null,this.apiService=new t(e.apiBaseUrl,e.apiKey),this.fileUploadService=new n,this.state={conversations:{},activeConversationId:null,isMinimized:!1,isSidebarOpen:!1,isWaitingForResponse:!1,maxRetries:10,retryDelay:1500,initialRetryDelay:2e3,userData:null,showLeadForm:!1},this.container=this.createContainer(),this.launcher=this.createLauncher(),document.body.appendChild(this.container),document.body.appendChild(this.launcher),this.ensureCorrectDOMStructure(),this.injectCitationStyles(),document.addEventListener("showCitation",(e=>{this.showCitationPopup(e.detail)})),document.addEventListener("click",(e=>{window.__lastClickPosition={clientX:e.clientX,clientY:e.clientY}})),this.checkUserIdentification().then((()=>{console.log("User identification complete, waiting for user to click launcher")})),this.addEventListeners()}checkUserIdentification(){return h(this,void 0,void 0,(function*(){let e=localStorage.getItem("chatbot_user_id");if(console.log("localStorage userId:",e),e||(e=function(){const e=document.cookie.split(";");for(let t=0;t<e.length;t++){const s=e[t].split("=");if("chatbot_user_id"===s[0].trim())return decodeURIComponent(s[1])}return null}(),console.log("Cookie userId:",e)),e){const t=`user_${e}`,s=localStorage.getItem(t);console.log("Raw user data from localStorage:",s);const n=yield this.apiService.checkUserExists(e);if(console.log("Loaded user data from API service:",n),n)return this.state.userData=n,n.lastSeen=Date.now(),yield this.apiService.updateUserData(n),void console.log("Returning user identified:",e,"hasCompletedLeadForm:",n.hasCompletedLeadForm)}const t=c();!function(e,t){const s=new Date;s.setDate(s.getDate()+365);const n=encodeURIComponent(t)+`; expires=${s.toUTCString()}; path=/; SameSite=Strict`;document.cookie=`chatbot_user_id=${n}`}(0,t),localStorage.setItem("chatbot_user_id",t),this.state.userData={userId:t,firstSeen:Date.now(),lastSeen:Date.now(),conversationIds:[],hasCompletedLeadForm:!1},this.state.showLeadForm=!0,console.log("New user created:",t)}))}shouldShowLeadForm(){return!0===this.state.showLeadForm||!!this.state.userData&&!this.state.userData.hasCompletedLeadForm&&!this.state.userData.leadInfo}showLeadForm(){console.log("Showing lead form"),this.state.showLeadForm=!0;const e=document.getElementById("chatbot-main");e&&(e.innerHTML=""),this.leadForm=new d("chatbot-main",this.handleLeadSubmit.bind(this),this.handleLeadSkip.bind(this));const t=document.getElementById("empty-state"),s=document.getElementById("messages-container"),n=document.getElementById("input-container");t&&(t.style.display="none"),s&&(s.style.display="none"),n&&(n.style.display="none")}handleLeadSubmit(e){return h(this,void 0,void 0,(function*(){if(console.log("Lead form submitted:",e),!this.state.userData)return void console.error("No user data available");e.userId=this.state.userData.userId,this.state.userData.leadInfo=e,this.state.userData.hasCompletedLeadForm=!0,console.log("Updated user data:",this.state.userData);const t=this.state.activeConversationId;yield this.apiService.submitLead(e,t),t&&(yield this.apiService.updateLeadConversation(e.userId,t));const s=yield this.apiService.updateUserData(this.state.userData);console.log("User data update result:",s),this.leadForm&&(this.leadForm.remove(),this.leadForm=null),this.state.showLeadForm=!1,this.ensureCorrectDOMStructure(),this.addEventListeners(),this.createNewChat(),this.state.activeConversationId&&this.state.conversations[this.state.activeConversationId]&&(this.state.conversations[this.state.activeConversationId].leadInfo=e,o(this.state.conversations)),setTimeout((()=>{const t=`Hi ${e.name||"there"}, Welcome! Our chatbot is powered by Radius X. How may I help you today?`;this.simulateBotMessage(t)}),500)}))}handleLeadSkip(){console.log("Lead form skipped"),this.state.userData&&(this.state.userData.hasCompletedLeadForm=!0,this.apiService.updateUserData(this.state.userData)),this.leadForm&&(this.leadForm.remove(),this.leadForm=null),this.state.showLeadForm=!1,this.ensureCorrectDOMStructure(),this.addEventListeners(),this.state.activeConversationId||(this.createNewChat(),setTimeout((()=>{this.simulateBotMessage("Hi there! How can I help you today?")}),500))}showEmptyState(){const e=document.getElementById("empty-state"),t=document.getElementById("messages-container"),s=document.getElementById("input-container");e&&(e.style.display="flex"),t&&(t.style.display="none"),s&&(s.style.display="none")}simulateBotMessage(e){if(!this.state.activeConversationId)return;const t={role:"assistant",content:[{contentType:"text",body:e}],createTime:Date.now()};this.addMessageToUI(t);const s="bot-welcome-"+Date.now(),n=this.state.conversations[this.state.activeConversationId];n&&n.messageMap&&(n.messageMap[s]=t),o(this.state.conversations)}createContainer(){const e=document.createElement("div");return e.id="chatbot-container",e.className="chatbot-container",e.style.display="none",e}createLauncher(){const e=document.createElement("div");e.id="chatbot-launcher",e.style.display="flex",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.width="60px",e.style.height="60px",e.style.borderRadius="50%",e.style.backgroundColor="#d32f2f",e.style.color="white",e.style.cursor="pointer",e.style.justifyContent="center",e.style.alignItems="center",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",e.style.zIndex="999",e.style.transition="all 0.3s ease";const t=i(a,24,24);e.appendChild(t);const s=this.createHoverPopup();let n;document.body.appendChild(s);let o=!1;return e.addEventListener("mouseenter",(()=>{clearTimeout(n),n=setTimeout((()=>{s.style.display="flex",s.style.opacity="1",o||(this.playBellSound(),o=!0)}),300)})),e.addEventListener("mouseleave",(()=>{clearTimeout(n),s.style.opacity="0",setTimeout((()=>{s.style.display="none",o=!1}),200)})),s.addEventListener("mouseleave",(()=>{s.style.opacity="0",setTimeout((()=>{s.style.display="none",o=!1}),200)})),e}createHoverPopup(){const e=document.createElement("div");e.id="chatbot-hover-popup",e.style.position="fixed",e.style.bottom="20px",e.style.right="90px",e.style.backgroundColor="white",e.style.borderRadius="12px",e.style.padding="16px",e.style.boxShadow="0 8px 24px rgba(0, 0, 0, 0.15)",e.style.display="none",e.style.opacity="0",e.style.transition="opacity 0.2s ease",e.style.zIndex="998",e.style.minWidth="280px",e.style.maxWidth="320px",e.style.border="1px solid #e2e8f0";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="12px";const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.width="40px",s.style.height="40px",s.style.backgroundColor="#d32f2f",s.style.borderRadius="8px",s.style.color="white",s.style.flexShrink="0";const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","20"),n.setAttribute("height","20"),n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("fill","none"),n.setAttribute("stroke","currentColor"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),n.setAttribute("stroke-linejoin","round");const o=document.createElementNS("http://www.w3.org/2000/svg","path");o.setAttribute("d","M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"),n.appendChild(o);const i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d","M12 8l1.5 4.5L18 13.5l-3.5 3 1 4.5L12 18.5l-3.5 2.5 1-4.5L6 13.5l4.5-1z"),i.setAttribute("fill","white"),n.appendChild(i),s.appendChild(n),t.appendChild(s);const a=document.createElement("div");a.style.flex="1",a.style.minWidth="0";const r=document.createElement("div");r.textContent="Have a question?",r.style.fontWeight="600",r.style.fontSize="14px",r.style.color="#2d3748",r.style.marginBottom="2px",a.appendChild(r);const l=document.createElement("div");l.textContent="Let us help you today!",l.style.fontSize="12px",l.style.color="#718096",a.appendChild(l),t.appendChild(a);const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.width="40px",c.style.height="40px",c.style.color="#d32f2f",c.style.flexShrink="0";const d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("width","24"),d.setAttribute("height","24"),d.setAttribute("viewBox","0 0 24 24"),d.setAttribute("fill","none"),d.setAttribute("stroke","currentColor"),d.setAttribute("stroke-width","2"),d.setAttribute("stroke-linecap","round"),d.setAttribute("stroke-linejoin","round");const h=document.createElementNS("http://www.w3.org/2000/svg","path");return h.setAttribute("d","M5 12h14M12 5l7 7-7 7"),d.appendChild(h),c.appendChild(d),t.appendChild(c),e.appendChild(t),e}playBellSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.exponentialRampToValueAtTime(400,e.currentTime+.1),t.type="sine",s.gain.setValueAtTime(0,e.currentTime),s.gain.linearRampToValueAtTime(.3,e.currentTime+.01),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}catch(e){console.log("Could not play bell sound:",e);try{const e=new Audio;e.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT",e.volume=.3,e.play().catch((()=>{console.log("HTML5 Audio fallback also failed")}))}catch(e){console.log("All audio methods failed:",e)}}}ensureCorrectDOMStructure(){for(console.log("Initial DOM structure:",this.container.innerHTML);this.container.firstChild;)this.container.removeChild(this.container.firstChild);this.container.style.flexDirection="column",this.container.style.zIndex="1000";const e=document.createElement("div");e.className="chatbot-header",e.id="chatbot-header",e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.padding="12px 16px",e.style.backgroundColor="#d32f2f",e.style.color="white",e.style.borderRadius="8px 8px 0 0",e.style.cursor="pointer";const t=document.createElement("div");t.className="logo-title",t.style.display="flex",t.style.alignItems="center",t.style.gap="10px";const s=i(a,20,20);t.appendChild(s);const n=document.createElement("div");n.className="chatbot-title",n.textContent="Chatbot",n.style.fontSize="16px",n.style.fontWeight="500",t.appendChild(n),e.appendChild(t);const o=document.createElement("div");o.className="header-actions",o.style.display="flex",o.style.gap="10px";const l=document.createElement("button");l.className="header-button",l.id="toggle-sidebar",l.style.background="none",l.style.border="none",l.style.color="white",l.style.cursor="pointer",l.style.fontSize="18px",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.width="24px",l.style.height="24px",l.style.transition="all 0.3s ease",l.style.borderRadius="50%",l.appendChild(i("M3 12h18M3 6h18M3 18h18")),l.addEventListener("click",this.toggleSidebar.bind(this)),o.appendChild(l);const c=document.createElement("button");c.className="header-button",c.id="minimize-btn",c.style.background="none",c.style.border="none",c.style.color="white",c.style.cursor="pointer",c.style.fontSize="18px",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.width="24px",c.style.height="24px",c.style.transition="all 0.3s ease",c.style.borderRadius="50%",c.appendChild(i("M5 12h14")),c.addEventListener("click",this.toggleMinimize.bind(this)),o.appendChild(c);const d=document.createElement("button");d.className="header-button",d.id="close-btn",d.style.background="none",d.style.border="none",d.style.color="white",d.style.cursor="pointer",d.style.fontSize="18px",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.style.width="24px",d.style.height="24px",d.style.transition="all 0.3s ease",d.style.borderRadius="50%",d.appendChild(i("M18 6L6 18M6 6l12 12")),d.addEventListener("click",this.closeChatbot.bind(this)),o.appendChild(d),e.appendChild(o);const h=document.createElement("div");h.className="chatbot-layout",h.id="chatbot-layout",h.style.display="flex",h.style.flexDirection="row",h.style.height="calc(100% - 59px)",h.style.position="relative",h.style.overflow="hidden";const u=document.createElement("div");u.className="chatbot-sidebar",u.id="chatbot-sidebar",u.style.width="0",u.style.minWidth="0",u.style.backgroundColor="#edf2f7",u.style.overflowY="auto",u.style.borderRight="1px solid #e2e8f0",u.style.transition="all 0.3s ease",u.style.flexShrink="0",u.style.order="0";const p=document.createElement("div");p.className="sidebar-header",p.style.padding="12px",p.style.borderBottom="1px solid #e2e8f0",p.style.display="flex",p.style.justifyContent="space-between",p.style.alignItems="center";const m=document.createElement("button");m.className="new-chat-btn",m.id="new-chat-btn",m.textContent="New Chat",m.style.backgroundColor="#d32f2f",m.style.color="white",m.style.border="none",m.style.padding="8px 12px",m.style.borderRadius="4px",m.style.cursor="pointer",m.style.fontSize="14px",m.addEventListener("click",this.createNewChat.bind(this)),p.appendChild(m),u.appendChild(p);const y=document.createElement("div");y.className="conversations-list",y.id="conversations-list",y.style.padding="8px",u.appendChild(y);const g=document.createElement("div");g.className="chatbot-main",g.id="chatbot-main",g.style.flex="1",g.style.display="flex",g.style.flexDirection="column",g.style.height="100%",g.style.minWidth="0",g.style.overflow="hidden",g.style.order="1";const f=document.createElement("div");f.className="empty-state",f.id="empty-state",f.style.display="flex",f.style.flexDirection="column",f.style.alignItems="center",f.style.justifyContent="center",f.style.height="100%",f.style.padding="20px",f.style.textAlign="center";const v=document.createElement("h3");v.className="empty-state-title",v.textContent="Welcome to AI Chatbot",v.style.fontSize="18px",v.style.fontWeight="500",v.style.marginBottom="8px",f.appendChild(v);const b=document.createElement("p");b.className="empty-state-description",b.textContent="Start a new conversation or select an existing one from the sidebar.",b.style.fontSize="14px",b.style.color="#a0aec0",b.style.marginBottom="16px",f.appendChild(b);const x=document.createElement("button");x.className="start-chat-btn",x.id="start-chat-btn",x.textContent="Start a new chat",x.style.backgroundColor="#d32f2f",x.style.color="white",x.style.border="none",x.style.padding="10px 16px",x.style.borderRadius="8px",x.style.cursor="pointer",x.style.fontSize="14px",x.addEventListener("click",this.createNewChat.bind(this)),f.appendChild(x);const C=document.createElement("div");C.className="messages-container",C.id="messages-container",C.style.flex="1",C.style.padding="16px",C.style.overflowY="auto",C.style.display="none",C.style.flexDirection="column";const w=document.createElement("div");w.className="input-container",w.id="input-container",w.style.padding="12px",w.style.borderTop="1px solid #e2e8f0",w.style.display="none";const I="claude-v3.5-sonnet",E=document.createElement("div");E.className="input-area",E.style.display="flex",E.style.gap="8px";const S=document.createElement("textarea");S.className="message-input",S.id="message-input",S.placeholder="Type a message...",S.rows=1,S.style.flex="1",S.style.border="1px solid #e2e8f0",S.style.borderRadius="8px",S.style.padding="10px 14px",S.style.resize="none",S.style.height="40px",S.style.maxHeight="120px",S.style.outline="none",S.style.fontSize="14px",S.addEventListener("keydown",(e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=S.value.trim();t&&!this.state.isWaitingForResponse&&(this.sendMessage(t,I),S.value="",S.style.height="auto")}})),S.addEventListener("input",(()=>{S.style.height="auto",S.style.height=(S.scrollHeight>120?120:S.scrollHeight)+"px",L.disabled=""===S.value.trim()||this.state.isWaitingForResponse})),E.appendChild(S);const M=document.createElement("button");M.className="attachment-button",M.id="attachment-button",M.type="button",M.title="Attach file",M.appendChild(i(r)),this.attachmentButton=M;const k=document.createElement("input");k.type="file",k.id="file-input",k.style.display="none",k.multiple=!0,k.accept="*/*",this.fileInput=k,M.addEventListener("click",(()=>{k.click()})),k.addEventListener("change",(e=>{const t=e.target;t.files&&t.files.length>0&&(this.handleFileSelection(t.files),t.value="")})),E.appendChild(M),E.appendChild(k);const L=document.createElement("button");L.className="send-button",L.id="send-button",L.disabled=!0,L.style.backgroundColor="#6b46c1",L.style.color="white",L.style.border="none",L.style.width="40px",L.style.height="40px",L.style.borderRadius="8px",L.style.cursor="pointer",L.style.display="flex",L.style.alignItems="center",L.style.justifyContent="center",L.appendChild(i("M22 2L11 13M22 2L15 22 11 13 2 9 22 2")),L.addEventListener("click",(()=>{const e=S.value.trim();e&&!this.state.isWaitingForResponse&&(this.sendMessage(e,I),S.value="",S.style.height="auto",L.disabled=!0)})),E.appendChild(L),w.appendChild(E),h.appendChild(u),h.appendChild(g),g.appendChild(f),g.appendChild(C),g.appendChild(w),this.container.appendChild(e),this.container.appendChild(h),console.log("Final DOM structure:",this.container.innerHTML)}loadConversations(){console.log("Loading conversations from storage...");const e=function(){try{const e=localStorage.getItem("chatbotConversations");if(!e)return{};const t=JSON.parse(e),s={};return Object.keys(t).forEach((e=>{const n=t[e];if(s[e]={id:n.id||e,createTime:n.createTime||Date.now(),title:n.title||"Conversation",messageMap:{},leadInfo:n.leadInfo||void 0},n.messageMap){const t={};Object.keys(n.messageMap).forEach((e=>{const s=n.messageMap[e];s&&(t[e]={role:"bot"===s.role?"assistant":s.role||"user",content:s.content||[{contentType:"text",body:""}],createTime:s.createTime||Date.now()})})),s[e].messageMap=t}})),s}catch(e){return console.error("Error loading conversations from localStorage:",e),{}}}();console.log("Stored conversations:",e);for(const[t,s]of Object.entries(e)){s.messageMap||(s.messageMap={});const e=Object.values(s.messageMap);if(e.forEach((e=>{e.createTime||(e.createTime=Date.now()),"bot"===e.role&&(e.role="assistant")})),!s.title||""===s.title.trim()||"Conversation"===s.title||"New Conversation"===s.title){e.sort(((e,t)=>(e.createTime||0)-(t.createTime||0)));const t=e.find((e=>"user"===e.role));if(t&&t.content&&t.content.length>0){const e=t.content[0].body;s.title=e.length>30?e.substring(0,27)+"...":e}else s.title="Conversation"}}this.state.conversations=e;const t=Object.keys(this.state.conversations).length>0;if(console.log("Has conversations:",t),t){const e=Object.keys(this.state.conversations).sort(((e,t)=>this.state.conversations[t].createTime-this.state.conversations[e].createTime))[0];console.log("Most recent conversation ID:",e),this.updateConversationsList(),this.setActiveConversation(e)}else{console.log("No conversations found, showing empty state");const e=document.getElementById("empty-state"),t=document.getElementById("messages-container"),s=document.getElementById("input-container");e&&(e.style.display="flex"),t&&(t.style.display="none"),s&&(s.style.display="none")}this.state.userData&&(this.state.userData.conversationIds=Object.keys(this.state.conversations),this.apiService.updateUserData(this.state.userData))}addEventListeners(){this.launcher.addEventListener("click",(()=>{console.log("Launcher clicked, isMinimized:",this.state.isMinimized),this.state.isMinimized?(console.log("Restoring minimized chatbot"),this.container.style.display="flex",this.container.classList.remove("minimized"),this.container.style.height="600px",this.container.style.overflow="hidden",this.launcher.style.display="none",this.state.isMinimized=!1):(console.log("Opening closed chatbot"),this.container.style.display="flex",this.container.classList.remove("minimized"),this.container.style.height="600px",this.container.style.overflow="hidden",this.launcher.style.display="none",this.state.isMinimized=!1,this.shouldShowLeadForm()?this.showLeadForm():this.loadConversations())})),this.container.addEventListener("click",(e=>{if(this.state.isMinimized){const t=e.target;t.closest(".header-actions")||t.closest(".header-button")||(console.log("Minimized container clicked, restoring chatbot"),this.container.style.display="flex",this.container.classList.remove("minimized"),this.container.style.height="600px",this.container.style.overflow="hidden",this.launcher.style.display="none",this.state.isMinimized=!1)}}));const e=document.getElementById("chatbot-header");e&&e.addEventListener("click",(t=>{var s;const n=t.target;(n===e||n.classList.contains("chatbot-title")||n.classList.contains("logo-title")||(null===(s=n.parentElement)||void 0===s?void 0:s.classList.contains("logo-title")))&&this.state.isMinimized&&(this.container.classList.remove("minimized"),this.container.style.height="600px",this.container.style.overflow="hidden",this.state.isMinimized=!1)})),document.addEventListener("click",(e=>{window.__lastClickPosition={clientX:e.clientX,clientY:e.clientY}})),document.addEventListener("showCitation",(e=>{this.showCitationPopup(e.detail)}))}toggleSidebar(){console.log("Toggling sidebar"),this.state.isSidebarOpen=!this.state.isSidebarOpen;const e=document.getElementById("chatbot-sidebar");e&&(this.state.isSidebarOpen?(e.style.width="180px",e.style.minWidth="180px"):(e.style.width="0",e.style.minWidth="0"))}toggleMinimize(){this.state.isMinimized?(console.log("Maximizing chatbot"),this.state.isMinimized=!1,this.container.classList.remove("minimized"),this.container.style.height="600px",this.container.style.overflow="hidden",this.launcher.style.display="none",console.log("Chatbot maximized, isMinimized:",this.state.isMinimized)):(console.log("Minimizing chatbot"),this.state.isMinimized=!0,this.container.classList.add("minimized"),this.container.style.height="60px",this.container.style.overflow="hidden",this.launcher.style.display="flex",console.log("Chatbot minimized, isMinimized:",this.state.isMinimized))}minimizeChatbot(){console.log("Minimizing chatbot"),this.state.isMinimized=!0,this.container.classList.add("minimized"),this.container.style.height="60px",this.container.style.overflow="hidden",this.launcher.style.display="flex",console.log("Chatbot minimized, isMinimized:",this.state.isMinimized)}closeChatbot(){this.container.style.display="none",this.launcher.style.display="flex"}updateConversationsList(){const e=document.getElementById("conversations-list");if(!e)return;e.innerHTML="";const t=Object.keys(this.state.conversations);0!==t.length&&(t.sort(((e,t)=>this.state.conversations[t].createTime-this.state.conversations[e].createTime)),t.forEach((t=>{const s=this.state.conversations[t];this.ensureValidTitle(t);const n=document.createElement("div");n.classList.add("conversation-item"),n.dataset.id=t,t===this.state.activeConversationId&&n.classList.add("active"),n.style.padding="10px",n.style.borderRadius="4px",n.style.marginBottom="4px",n.style.cursor="pointer",n.style.transition="all 0.3s ease",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.style.fontSize="14px",t===this.state.activeConversationId&&(n.style.backgroundColor="#e2e8f0",n.style.fontWeight="500");const o=s.title||"Conversation";n.textContent=o,n.addEventListener("click",(()=>{this.setActiveConversation(t)})),e.appendChild(n)})),this.state.userData&&(this.state.userData.conversationIds=t,this.apiService.updateUserData(this.state.userData)))}ensureValidTitle(e){const t=this.state.conversations[e];if(!t)return;if(t.title&&"New Conversation"!==t.title&&"Conversation"!==t.title&&""!==t.title.trim())return;const s=Object.values(t.messageMap||{});if(0===s.length)return;s.sort(((e,t)=>(e.createTime||0)-(t.createTime||0)));const n=s.filter((e=>"user"===e.role));if(n.length>0){const e=n[0];if(e.content&&e.content.length>0){const s=e.content[0].body;s&&(t.title=s.length>30?s.substring(0,27)+"...":s,o(this.state.conversations))}}}setActiveConversation(e){if(this.state.activeConversationId===e)return;console.log(`Setting active conversation to ${e}`),this.state.activeConversationId&&this.state.conversations[this.state.activeConversationId]&&o(this.state.conversations),this.state.activeConversationId=e;const t=document.getElementById("empty-state"),s=document.getElementById("messages-container"),n=document.getElementById("input-container");t&&(t.style.display="none"),s&&(s.style.display="flex",s.innerHTML=""),n&&(n.style.display="flex"),this.state.conversations[e]?this.state.conversations[e].messageMap||(this.state.conversations[e].messageMap={}):(this.state.conversations[e]={id:e,createTime:Date.now(),title:"New Conversation",messageMap:{}},this.state.userData&&this.state.userData.leadInfo&&(this.state.conversations[e].leadInfo=this.state.userData.leadInfo));const i=!(Object.keys(this.state.conversations[e].messageMap).length>0);this.renderMessages(),i?this.fetchConversation(e).then((()=>{console.log("Fetched conversation from server"),this.ensureValidTitle(e),this.renderMessages(),this.updateConversationsList()})).catch((e=>{console.error("Error fetching conversation:",e)})):(this.ensureValidTitle(e),this.updateConversationsList());const a=document.getElementById("message-input");a&&(a.value="",a.focus()),this.state.userData&&(this.state.userData.conversationIds.includes(e)||(this.state.userData.conversationIds.push(e),this.apiService.updateUserData(this.state.userData)))}createNewChat(){if(console.log("Creating new chat"),this.shouldShowLeadForm())return void this.showLeadForm();const e=c(),t={id:e,createTime:Date.now(),title:"New Conversation",messageMap:{}};this.state.userData&&this.state.userData.leadInfo&&(t.leadInfo=this.state.userData.leadInfo),this.state.conversations[e]=t,o(this.state.conversations),this.state.activeConversationId=e;const s=document.getElementById("empty-state"),n=document.getElementById("messages-container"),i=document.getElementById("input-container");s&&(s.style.display="none"),n&&(n.style.display="flex",n.innerHTML=""),i&&(i.style.display="flex"),this.updateConversationsList();const a=document.getElementById("message-input");a&&(a.value="",a.focus()),this.state.userData&&(this.state.userData.conversationIds.push(e),this.apiService.updateUserData(this.state.userData))}renderMessages(){console.log("renderMessages called");const e=document.getElementById("messages-container");if(console.log("messagesContainer found:",!!e),!e)return void console.log("No messages container found, returning");if(e.innerHTML="",!this.state.activeConversationId||!this.state.conversations[this.state.activeConversationId])return void console.log("No active conversation or conversation not found");const t=this.state.conversations[this.state.activeConversationId].messageMap;if(console.log("Message map keys:",Object.keys(t||{})),!t||0===Object.keys(t).length)return void console.log("No messages in conversation");const s=Object.values(t);s.forEach((e=>{e.createTime||(e.createTime=Date.now()),"user"!==e.role&&"assistant"!==e.role&&(["bot","ai","claude"].includes(e.role)?e.role="assistant":e.role="user")})),s.sort(((e,t)=>(e.createTime||0)-(t.createTime||0))),s.forEach((e=>{this.addMessageToUI(e)})),e.scrollTop=e.scrollHeight}addMessageToUI(e){const t=document.getElementById("messages-container");if(!t)return;if(!e||!e.content||0===e.content.length)return void console.error("Attempted to add invalid message to UI",e);const s=document.createElement("div");if(s.classList.add("message"),s.style.maxWidth="80%",s.style.padding="10px 14px",s.style.borderRadius="18px",s.style.fontSize="14px",s.style.lineHeight="1.4",s.style.position="relative",s.style.whiteSpace="pre-wrap",s.style.marginBottom="12px","user"===("bot"===e.role?"assistant":e.role)){s.classList.add("user-message"),s.style.alignSelf="flex-end",s.style.backgroundColor="#e0e7ff",s.style.borderBottomRightRadius="4px",s.style.color="#2d3748",s.style.marginLeft="auto",s.style.marginRight="0",s.innerHTML="";for(const t of e.content)if("text"===t.contentType){const e=document.createElement("div");e.textContent=t.body,s.appendChild(e)}else if("file"===t.contentType){const e=t.body,n=this.createFileAttachmentElement(e);s.appendChild(n)}}else{s.classList.add("assistant-message"),s.style.alignSelf="flex-start",s.style.backgroundColor="#f5f5f5",s.style.borderBottomLeftRadius="4px",s.style.marginLeft="0",s.style.marginRight="auto";const t=e.content[0];if("text"===t.contentType){let n=t.body;n=this.convertUrlsToLinks(n),n=this.processCitationReferences(n,e);const o=500;if(n.length>o){const e=n.substring(0,o)+"...",t=n,i=document.createElement("div");i.innerHTML=e;const a=document.createElement("button");a.textContent="Read more",a.style.background="none",a.style.border="none",a.style.color="#6b46c1",a.style.cursor="pointer",a.style.fontSize="12px",a.style.padding="4px 0",a.style.marginTop="8px",a.style.textDecoration="underline";let r=!1;a.addEventListener("click",(()=>{r?(i.innerHTML=e,a.textContent="Read more",r=!1):(i.innerHTML=t,a.textContent="Read less",r=!0)})),s.innerHTML="",s.appendChild(i),s.appendChild(a)}else s.innerHTML=n}}if(e.createTime){const t=document.createElement("span");t.classList.add("timestamp"),t.textContent=this.formatTimestamp(e.createTime),t.style.fontSize="10px",t.style.color="#a0aec0",t.style.marginTop="4px",t.style.display="block",s.appendChild(t)}t.style.display="flex",t.style.flexDirection="column",t.appendChild(s),t.scrollTop=t.scrollHeight}convertUrlsToLinks(e){console.log("Converting URLs in text:",e);let t=e;return[/(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/g,/(www\.[^\s<]+[^<.,:;"')\]\s])/g,/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g].forEach((e=>{t=t.replace(e,(e=>{console.log("Found URL match:",e);let t=e;t.startsWith("www.")&&(t="https://"+t),t.includes("@")&&(t="mailto:"+t);const s=`<a href="${t}" target="_blank" rel="noopener noreferrer" style="color: #d32f2f; text-decoration: underline;">${e}</a>`;return console.log("Generated link HTML:",s),s}))})),console.log("Final processed text:",t),t}processCitationReferences(e,t){const s=this.state.activeConversationId?this.state.conversations[this.state.activeConversationId]:null;if(!s)return e;s.citationMappings||(s.citationMappings={});let n=e.replace(/\[\^(tooluse_[a-zA-Z0-9_-]+@\d+)\]/g,((e,t)=>{const n=`citation-${t.replace(/[@.]/g,"-")}`;let i="";const a=s.citationMappings||{};for(const[e,s]of Object.entries(a))if(s===t){i=e;break}if(!i){const e=Object.keys(a).map((e=>parseInt(e))).filter((e=>!isNaN(e)));i=(e.length>0?Math.max(...e)+1:1).toString(),s.citationMappings[i]=t,o(this.state.conversations)}return`<span class="citation-reference" id="${n}" \n      data-reference="${t}">\n      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none">\n        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>\n        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>\n      </svg>\n    </span>`}));return n=n.replace(/\[\^(\d+)\]/g,((e,t)=>{const n=(s.citationMappings||{})[t];return n?`<span class="citation-reference" id="citation-${n.replace(/[@.]/g,"-")}-${t}" \n        data-reference="${n}">\n        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none">\n          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>\n          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>\n        </svg>\n      </span>`:e})),n}injectCitationStyles(){if(!document.getElementById("citation-styles")){const e=document.createElement("style");e.id="citation-styles",e.textContent="\n        /* Citation reference buttons */\n        .citation-reference {\n          display: inline-flex;\n          align-items: center;\n          justify-content: center;\n          color: #4267B2;\n          margin: 0 2px;\n          padding: 2px;\n          border-radius: 3px;\n          cursor: pointer;\n          background-color: rgba(66, 103, 178, 0.1);\n        }\n        \n        .citation-reference:hover {\n          background-color: rgba(66, 103, 178, 0.2);\n        }\n        \n        /* Citation popup styling */\n        #citation-popup {\n          position: fixed;\n          z-index: 2000;\n          max-width: 400px;\n          width: auto;\n          background-color: white;\n          border: 1px solid #e2e8f0;\n          border-radius: 8px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n          padding: 12px 16px;\n          font-size: 14px;\n          max-height: 300px;\n          overflow-y: auto;\n          color: #2d3748;\n          cursor: move;\n        }\n        \n        #citation-popup .popup-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-bottom: 1px solid #e2e8f0;\n          padding-bottom: 8px;\n          margin-bottom: 8px;\n          cursor: move;\n        }\n        \n        #citation-popup .popup-title {\n          font-weight: bold;\n          margin: 0;\n          padding-right: 24px;\n        }\n        \n        #citation-popup .popup-source-url {\n          margin-bottom: 10px;\n          padding: 6px;\n          background-color: #f8f9fa;\n          border-radius: 4px;\n        }\n        \n        #citation-popup .popup-source-url a {\n          color: #4267B2;\n          text-decoration: none;\n          font-weight: 500;\n          display: flex;\n          align-items: center;\n        }\n        \n        #citation-popup .popup-source-url a:hover {\n          text-decoration: underline;\n        }\n        \n        #citation-popup .popup-content {\n          color: #4a5568;\n          line-height: 1.5;\n          white-space: pre-line;\n        }\n        \n        #citation-popup .close-button {\n          border: none;\n          background: none;\n          cursor: pointer;\n          font-size: 16px;\n          color: #a0aec0;\n          padding: 0;\n          width: 24px;\n          height: 24px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 50%;\n        }\n        \n        #citation-popup .close-button:hover {\n          background-color: #f7fafc;\n          color: #718096;\n        }\n      ",document.head.appendChild(e),document.addEventListener("click",(e=>{const t=e.target.closest(".citation-reference");if(t){e.preventDefault(),e.stopPropagation();const s=t.getAttribute("data-reference");s&&this.showCitationPopup(s)}}))}}showCitationPopup(e){console.log("Citation clicked:",e);const t=document.getElementById("citation-popup");t&&t.remove();const s=document.createElement("div");s.id="citation-popup";const n=this.state.activeConversationId?this.state.conversations[this.state.activeConversationId]:null;if(!n)return s.innerHTML='<div style="color:red;">Reference not found.</div>',void document.body.appendChild(s);const o=Object.values(n.messageMap||{}).filter((e=>"assistant"===e.role));let i=null,a=null;const[r,l]=e.split("@");for(const e of o)if(e.thinkingLog){for(const t of e.thinkingLog)if(t.content){for(const e of t.content)if("toolResult"===e.contentType&&e.body&&e.body.toolUseId===r&&e.body.content&&e.body.content[parseInt(l)]&&e.body.content[parseInt(l)].json){const t=e.body.content[parseInt(l)].json;i=t.content,a=t.sourceUrl||null;break}if(i)break}if(i)break}let c="";a&&(c=`\n        <div class="popup-source-url">\n          <a href="${a}" target="_blank" rel="noopener noreferrer">\n            View source document\n            <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" fill="none" style="display:inline-block;vertical-align:middle;margin-left:4px;">\n              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n              <polyline points="15 3 21 3 21 9"></polyline>\n              <line x1="10" y1="14" x2="21" y2="3"></line>\n            </svg>\n          </a>\n        </div>\n      `);const d=`<div class="popup-content">${i||"Content not found"}</div>`;s.innerHTML='\n      <div class="popup-header">\n        <h3 class="popup-title">Source Reference</h3>\n        <button class="close-button"></button>\n      </div>\n    '+c+d,document.body.appendChild(s);const h=window.__lastClickPosition||{clientX:100,clientY:100},u=s.getBoundingClientRect();let p=h.clientY+20,m=h.clientX-20;const y=window.innerWidth,g=window.innerHeight;m+u.width>y-20&&(m=y-u.width-20),m<20&&(m=20),p+u.height>g-20&&(p=h.clientY-u.height-20),p<20&&(p=20),s.style.top=`${p}px`,s.style.left=`${m}px`;const f=s.querySelector(".close-button");f&&f.addEventListener("click",(()=>{s.remove()})),this.makeDraggable(s),document.addEventListener("click",(function e(t){s.contains(t.target)||(s.remove(),document.removeEventListener("click",e))}))}makeDraggable(e){let t=!1,s=0,n=0;(e.querySelector(".popup-header")||e).addEventListener("mousedown",(function(o){if(!(o instanceof MouseEvent)||0!==o.button)return;t=!0;const i=e.getBoundingClientRect();s=o.clientX-i.left,n=o.clientY-i.top,o.preventDefault()})),document.addEventListener("mousemove",(function(o){if(!(t&&o instanceof MouseEvent))return;const i=o.clientX-s,a=o.clientY-n;e.style.left=i+"px",e.style.top=a+"px"})),document.addEventListener("mouseup",(function(){t=!1}))}formatTimestamp(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}showThinkingIndicator(){const e=document.getElementById("messages-container");if(!e)return;const t=document.createElement("div");t.classList.add("thinking"),t.id="thinking-indicator",t.style.display="flex",t.style.gap="4px",t.style.padding="8px 14px",t.style.alignSelf="flex-start",t.style.backgroundColor="#f5f5f5",t.style.borderRadius="18px",t.style.borderBottomLeftRadius="4px";for(let e=0;e<3;e++){const s=document.createElement("div");s.classList.add("dot"),s.style.width="8px",s.style.height="8px",s.style.borderRadius="50%",s.style.backgroundColor="#a0aec0",s.style.animation="bounce 1.5s infinite ease-in-out",1===e&&(s.style.animationDelay="0.2s"),2===e&&(s.style.animationDelay="0.4s"),t.appendChild(s)}if(e.appendChild(t),e.scrollTop=e.scrollHeight,!document.getElementById("bounce-animation")){const e=document.createElement("style");e.id="bounce-animation",e.textContent="\n        @keyframes bounce {\n          0%, 80%, 100% { transform: translateY(0); }\n          40% { transform: translateY(-6px); }\n        }\n      ",document.head.appendChild(e)}}removeThinkingIndicator(){const e=document.getElementById("thinking-indicator");e&&e.remove()}sendMessage(e,t){return h(this,void 0,void 0,(function*(){var s;try{this.state.isWaitingForResponse=!0;const n=document.getElementById("message-input"),i=document.getElementById("send-button");n&&(n.disabled=!0),i&&(i.disabled=!0);const a={role:"user",content:[{contentType:"text",body:e}],createTime:Date.now()};this.addMessageToUI(a);const r={conversationId:this.state.activeConversationId||null,message:{model:t,content:[{contentType:"text",body:e}]},continueGenerate:!1},l=!this.state.activeConversationId||this.state.activeConversationId&&!this.state.conversations[this.state.activeConversationId],c=this.state.activeConversationId||"temp-"+Date.now();this.state.conversations[c]?this.state.conversations[c].title&&"Conversation"!==this.state.conversations[c].title&&"New Conversation"!==this.state.conversations[c].title||0!==Object.keys(this.state.conversations[c].messageMap||{}).length||(this.state.conversations[c].title=e):(this.state.conversations[c]={id:c,createTime:Date.now(),title:e,messageMap:{}},this.state.userData&&this.state.userData.leadInfo&&(this.state.conversations[c].leadInfo=this.state.userData.leadInfo)),this.state.conversations[c].messageMap||(this.state.conversations[c].messageMap={});const d="user-"+Date.now();this.state.conversations[c].messageMap[d]=a,l&&(this.state.activeConversationId=c),o(this.state.conversations),this.updateConversationsList(),this.showThinkingIndicator();const h=yield this.apiService.sendMessage(r),{conversationId:u,messageId:p}=h;if(console.log("API Response - ConversationId:",u,"MessageId:",p),u&&this.state.userData&&this.state.userData.leadInfo&&(yield this.apiService.updateLeadConversation(this.state.userData.userId,u)),u!==c&&c.startsWith("temp-")&&(console.log("Transferring user message from temp conversation to real conversation"),this.state.conversations[u]||(this.state.conversations[u]={id:u,createTime:Date.now(),title:e,messageMap:{}},this.state.userData&&this.state.userData.leadInfo&&(this.state.conversations[u].leadInfo=this.state.userData.leadInfo)),this.state.conversations[u].messageMap||(this.state.conversations[u].messageMap={}),this.state.conversations[u].messageMap[d]=a,this.state.conversations[u].title&&"Conversation"!==this.state.conversations[u].title&&"New Conversation"!==this.state.conversations[u].title||(this.state.conversations[u].title=e),delete this.state.conversations[c],this.state.activeConversationId=u,this.state.userData&&this.state.userData.leadInfo&&(yield this.apiService.updateLeadConversation(this.state.userData.userId,u),console.log("Updated lead with real conversation ID:",u)),o(this.state.conversations),this.updateConversationsList()),!(yield this.pollForMessage(u,p))&&(yield this.fetchConversation(u),!Object.values((null===(s=this.state.conversations[u])||void 0===s?void 0:s.messageMap)||{}).some((e=>"assistant"===e.role||"bot"===e.role)))){this.removeThinkingIndicator();const e={role:"assistant",content:[{contentType:"text",body:"Sorry, I wasn't able to retrieve the response. Please try again."}],createTime:Date.now()};this.addMessageToUI(e);const t="error-"+Date.now();this.state.conversations[u].messageMap[t]=e}this.state.userData&&!this.state.userData.conversationIds.includes(u)&&(this.state.userData.conversationIds.push(u),this.apiService.updateUserData(this.state.userData)),o(this.state.conversations)}catch(e){console.error("Error sending message:",e),this.removeThinkingIndicator();const t={role:"assistant",content:[{contentType:"text",body:"Sorry, there was an error processing your request. Please try again."}],createTime:Date.now()};if(this.addMessageToUI(t),this.state.activeConversationId&&this.state.conversations[this.state.activeConversationId]){const e="error-"+Date.now();this.state.conversations[this.state.activeConversationId].messageMap||(this.state.conversations[this.state.activeConversationId].messageMap={}),this.state.conversations[this.state.activeConversationId].messageMap[e]=t,o(this.state.conversations)}}finally{this.state.isWaitingForResponse=!1;const e=document.getElementById("message-input"),t=document.getElementById("send-button");e&&(e.disabled=!1,e.focus()),t&&(t.disabled=!e||""===e.value.trim()),this.removeThinkingIndicator()}}))}fetchConversation(e){return h(this,void 0,void 0,(function*(){let t=0;for(yield l(this.state.initialRetryDelay);t<this.state.maxRetries;)try{console.log(`Fetching conversation (attempt ${t+1}/${this.state.maxRetries})...`);const s=yield this.apiService.fetchConversation(e);s.messageMap||(s.messageMap={}),Object.values(s.messageMap).forEach((e=>{e.createTime||(e.createTime=Date.now())}));const n=Object.values(s.messageMap);if(n.length>0&&(n.sort(((e,t)=>(e.createTime||0)-(t.createTime||0))),!s.title||""===s.title.trim())){const e=n.find((e=>"user"===e.role));if(e&&e.content&&e.content.length>0){const t=e.content[0].body;s.title=t.length>30?t.substring(0,27)+"...":t}else s.title="Conversation"}return!s.leadInfo&&this.state.userData&&this.state.userData.leadInfo&&(s.leadInfo=this.state.userData.leadInfo),this.state.conversations[e]=s,this.state.activeConversationId===e&&this.renderMessages(),this.updateConversationsList(),o(this.state.conversations),void console.log("Conversation retrieved successfully")}catch(e){if(console.error("Error fetching conversation:",e),e instanceof Error&&(e.message.includes("404")||404===e.status||404===e.statusCode)?console.log("Conversation not ready yet, will retry after delay"):console.error("Unexpected error fetching conversation:",e),t++,t>=this.state.maxRetries){console.log("Max retries reached. Giving up on fetching conversation.");break}const s=this.state.retryDelay*Math.pow(1.5,t-1);console.log(`Waiting ${s}ms before next attempt...`),yield l(s)}console.error(`Failed to fetch conversation ${e} after ${this.state.maxRetries} attempts`),this.state.conversations[e]||(this.state.conversations[e]={id:e,createTime:Date.now(),title:"Conversation",messageMap:{}},this.state.userData&&this.state.userData.leadInfo&&(this.state.conversations[e].leadInfo=this.state.userData.leadInfo))}))}pollForMessage(e,t){return h(this,void 0,void 0,(function*(){let s=0;for(yield l(this.state.initialRetryDelay),console.log("Poll for Message been called");s<this.state.maxRetries;)try{console.log(`Polling for message (attempt ${s+1}/${this.state.maxRetries})...`);const n=yield this.apiService.fetchMessage(e,t);if(n.success&&n.message){console.log("Message retrieved successfully");const t=n.message;if("bot"===t.role&&(t.role="assistant"),t.createTime||(t.createTime=Date.now()),console.log("Bot message:",t),this.addMessageToUI(t),this.state.conversations[e]&&this.state.conversations[e].messageMap){const s=t.id||`bot-${Date.now()}`;this.state.conversations[e].messageMap[s]=t,o(this.state.conversations)}return t}if(404===n.status&&console.log("Message not ready yet, will retry after delay"),s++,s>=this.state.maxRetries){console.log("Max retries reached. Giving up.");break}const i=this.state.retryDelay*Math.pow(1.5,s-1);console.log(`Waiting ${i}ms before next attempt...`),yield l(i)}catch(e){if(console.error("Error polling for message:",e),s++,s>=this.state.maxRetries){console.log("Max retries reached. Giving up.");break}const t=this.state.retryDelay*Math.pow(1.5,s-1);yield l(t)}return null}))}handleFileSelection(e){return h(this,void 0,void 0,(function*(){var t,s;if(!(null===(t=this.state.userData)||void 0===t?void 0:t.userId))return void console.error("No user ID available for file upload");const n=this.state.activeConversationId||"general",o=(null===(s=this.state.userData.leadInfo)||void 0===s?void 0:s.email)||"unknown";this.createUploadProgressContainer();for(let t=0;t<e.length;t++){const s=e[t];yield this.uploadFile(s,n,o)}}))}createUploadProgressContainer(){if(this.uploadProgressContainer)return;const e=document.getElementById("messages-container");e&&(this.uploadProgressContainer=document.createElement("div"),this.uploadProgressContainer.id="upload-progress-container",this.uploadProgressContainer.style.padding="8px",this.uploadProgressContainer.style.borderTop="1px solid #e2e8f0",this.uploadProgressContainer.style.display="none",e.appendChild(this.uploadProgressContainer))}uploadFile(e,t,s){return h(this,void 0,void 0,(function*(){var n;if(!(null===(n=this.state.userData)||void 0===n?void 0:n.userId))return;const o=this.state.userData.userId;try{this.attachmentButton&&(this.attachmentButton.disabled=!0,this.attachmentButton.style.opacity="0.5"),this.uploadProgressContainer&&(this.uploadProgressContainer.style.display="block");const n=this.createFileProgressElement(e.name),i=yield this.fileUploadService.uploadFile(e,o,t,s,(e=>{this.updateFileProgress(n,e)}));this.addFileToConversation(i,t),setTimeout((()=>{n.remove()}),2e3)}catch(t){console.error("File upload failed:",t),this.showUploadError(e.name,t instanceof Error?t.message:"Upload failed")}finally{this.attachmentButton&&(this.attachmentButton.disabled=!1,this.attachmentButton.style.opacity="1")}}))}createFileProgressElement(e){const t=document.createElement("div");return t.className="file-upload-progress",t.innerHTML=`\n      <div class="file-upload-header">\n        <div class="file-name">${e}</div>\n        <div class="file-status uploading">Uploading...</div>\n      </div>\n      <div class="progress-bar">\n        <div class="progress-fill" style="width: 0%"></div>\n      </div>\n    `,this.uploadProgressContainer&&this.uploadProgressContainer.appendChild(t),t}updateFileProgress(e,t){const s=e.querySelector(".file-status"),n=e.querySelector(".progress-fill");s&&(s.textContent="uploading"===t.status?"Uploading...":"uploaded"===t.status?"Uploaded":"Failed",s.className=`file-status ${t.status}`),n&&(n.style.width=`${t.progress}%`,n.className=`progress-fill ${t.status}`)}showUploadError(e,t){const s=document.createElement("div");s.className="file-upload-progress",s.innerHTML=`\n      <div class="file-upload-header">\n        <div class="file-name">${e}</div>\n        <div class="file-status failed">Failed</div>\n      </div>\n      <div style="color: #e53e3e; font-size: 12px; margin-top: 4px;">${t}</div>\n    `,this.uploadProgressContainer&&this.uploadProgressContainer.appendChild(s),setTimeout((()=>{s.remove()}),5e3)}addFileToConversation(e,t){const s={fileId:e.fileId,fileName:e.fileName,fileSize:e.fileSize,fileType:e.fileType,s3Url:"",uploadTimestamp:e.uploadTimestamp},n=c(),i={role:"user",content:[{contentType:"text",body:` Attached: ${e.fileName}`},{contentType:"file",body:s}],createTime:Date.now(),id:n};this.state.conversations[t]&&(this.state.conversations[t].messageMap[n]=i,o(this.state.conversations)),this.addMessageToUI(i)}createFileAttachmentElement(e){const t=document.createElement("div");t.className="file-attachment",t.style.marginTop="8px";const s=document.createElement("div");s.className="file-attachment-icon",s.appendChild(i(r,16,16)),t.appendChild(s);const n=document.createElement("div");n.className="file-attachment-info";const o=document.createElement("div");o.className="file-attachment-name",o.textContent=e.fileName,n.appendChild(o);const a=document.createElement("div");a.className="file-attachment-size",a.textContent=this.formatFileSize(e.fileSize),n.appendChild(a),t.appendChild(n);const l=document.createElement("a");l.className="file-attachment-link";const c=this.fileUploadService.getFileDownloadUrl(e.fileId);return c?(l.href=c,l.target="_blank",l.rel="noopener noreferrer",l.textContent="Download",l.addEventListener("click",(()=>{setTimeout((()=>{this.fileUploadService.revokeDownloadUrl(c)}),1e3)}))):(l.textContent="File not available",l.style.pointerEvents="none",l.style.opacity="0.5"),t.appendChild(l),t}formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}}function p(){console.log("Verifying chatbot DOM structure...");const e=document.getElementById("chatbot-container");if(!e)return void console.error("Chatbot container not found!");console.log("Container structure:",e.outerHTML.substring(0,500)+"...");const t=Array.from(e.children).map((e=>`${e.tagName}.${e.className}`));console.log("Child elements order:",t);const s=document.getElementById("chatbot-layout");if(s){const e=Array.from(s.children).map((e=>`${e.tagName}.${e.className}`));console.log("Layout children:",e)}else console.error("Layout container not found!")}document.addEventListener("DOMContentLoaded",(()=>{const e=window.API_BASE_URL||"",t=window.API_KEY||"",s=window.FILE_UPLOAD_API_URL||e;setTimeout((()=>{try{new u({apiBaseUrl:e,apiKey:t,fileUploadApiUrl:s}),console.log("Chatbot initialized successfully"),setTimeout(p,500)}catch(e){console.error("Error initializing chatbot:",e)}}),100)}))})();